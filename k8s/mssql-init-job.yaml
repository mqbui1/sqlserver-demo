apiVersion: batch/v1
kind: Job
metadata:
  name: mssql-init
spec:
  backoffLimit: 5
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: init
          image: mcr.microsoft.com/mssql/server:2022-latest
          command:
            - /bin/bash
            - -c
            - |
              # Wait until SQL Server is ready
              until /opt/mssql-tools18/bin/sqlcmd -S mssql -U sa -P "${SA_PASSWORD}" -Q "SELECT 1" &>/dev/null; do
                echo "Waiting for SQL Server..."
                sleep 5
              done
              
              echo "Running init script..."
              /opt/mssql-tools18/bin/sqlcmd \
                -S mssql \
                -U sa \
                -P "${SA_PASSWORD}" \
                -b \
                -i /init/init.sql
          env:
            - name: SA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mssql-secret
                  key: SA_PASSWORD
          volumeMounts:
            - name: init-sql
              mountPath: /init
      volumes:
        - name: init-sql
          configMap:
            name: mssql-init
