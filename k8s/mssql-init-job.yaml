apiVersion: batch/v1
kind: Job
metadata:
  name: mssql-init-job
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: mssql-init
        image: mcr.microsoft.com/mssql-tools
        command:
          - /bin/bash
          - -c
          - |
            # Wait for SQL Server to be ready
            until /opt/mssql-tools/bin/sqlcmd -S mssql -U sa -P "$SA_PASSWORD" -Q "SELECT 1" > /dev/null 2>&1; do
              echo "Waiting for SQL Server..."
              sleep 2
            done
            echo "SQL Server ready. Running init script..."
            /opt/mssql-tools/bin/sqlcmd -S mssql -U sa -P "$SA_PASSWORD" -i /init/init.sql
        env:
          - name: SA_PASSWORD
            valueFrom:
              secretKeyRef:
                name: mssql-secret
                key: SA_PASSWORD
        volumeMounts:
        - name: init-scripts
          mountPath: /init
      volumes:
      - name: init-scripts
        configMap:
          name: mssql-init-scripts
